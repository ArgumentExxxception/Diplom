@page "/combined-import"
@using Core.Enums

<MudContainer MaxWidth="MaxWidth.False" Class="pa-6">
    <MudText Typo="Typo.h4" Class="mb-4">Импорт данных</MudText>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" @ref="_tabs">
        <MudTabPanel Text="Импорт в существующую таблицу" Icon="@Icons.Material.Filled.TableChart">
            <MudCard Elevation="4" Class="mb-4 pa-4">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Выбор таблицы и параметров</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudSelect T="string" Label="Таблица" @bind-Value="selectedTable" Required="true"
                                       HelperText="Выберите таблицу для импорта данных"
                                       AdornmentIcon="@Icons.Material.Filled.Storage" AdornmentColor="Color.Primary"
                                       SelectedValuesChanged="@(async () => await LoadTableStructure(selectedTable))">
                                @foreach (var table in availableTables)
                                {
                                    <MudSelectItem Value="@table">@table</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSelect T="int" Label="Режим импорта" @bind-Value="_dataImportMode" Required="true"
                                       HelperText="Выберите режим импорта данных"
                                       AdornmentIcon="@Icons.Material.Filled.MergeType" AdornmentColor="Color.Primary">
                                <MudSelectItem Value="ImportMode.Replace">Полная замена данных</MudSelectItem>
                                <MudSelectItem Value="ImportMode.Insert">Только добавление новых</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            @if (tableStructure.Count > 0)
            {
                @if (tableStructure.Count > 0)
                {
                    <MudTable ReadOnly="true" Items="@tableStructure" Hover="true" Striped="true" Bordered="true">
                        <HeaderContent>
                            <MudTh>Имя колонки</MudTh>
                            <MudTh>Тип данных</MudTh>
                            <MudTh>Обязательное</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Имя колонки">@context.Name</MudTd>
                            <MudTd DataLabel="Тип данных">@context.Type</MudTd>
                            <MudTd DataLabel="Обязательное">
                                <MudCheckBox ReadOnly="true" T="bool" @bind-Value="context.IsRequired" Color="Color.Primary" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            }
        </MudTabPanel>

        <MudTabPanel Text="Импорт в новую таблицу" Icon="@Icons.Material.Filled.Add">
            <MudCard Elevation="4" Class="mb-4 pa-4">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Создание новой таблицы</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudTextField @bind-Value="newTableName" Label="Название таблицы" Variant="Variant.Outlined" Class="mb-4" />

                    <MudGrid>
                        <MudItem xs="12" sm="6" md="3">
                            <MudTextField @bind-Value="newColumnName" Label="Название колонки" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudSelect T="ColumnTypes" @bind-Value="newColumnType" Label="Тип данных" Variant="Variant.Outlined">
                                <MudSelectItem T="ColumnTypes" Value="ColumnTypes.Text">Текст</MudSelectItem>
                                <MudSelectItem T="ColumnTypes" Value="ColumnTypes.Integer">Целое число</MudSelectItem>
                                <MudSelectItem T="ColumnTypes" Value="ColumnTypes.Date">Дата</MudSelectItem>
                                <MudSelectItem T="ColumnTypes" Value="ColumnTypes.Boolean">Логическое значение</MudSelectItem>
                                <MudSelectItem T="ColumnTypes" Value="ColumnTypes.Double">Дробное число</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudCheckBox T="bool" @bind-Checked="newColumnIsPrimaryKey" Label="Первичный ключ" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudCheckBox T="bool" @bind-Checked="newColumnIsRequired" Label="Обязательное поле" />
                        </MudItem>
                    </MudGrid>

                    <MudButton OnClick="AddColumn" Color="Color.Primary" Variant="Variant.Filled" Class="mt-3">
                        <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-2" />Добавить колонку
                    </MudButton>
                </MudCardContent>
            </MudCard>

            <MudExpansionPanel IsExpanded="true" Class="mb-4">
                <TitleContent>
                    <MudText Typo="Typo.h6">Колонки новой таблицы</MudText>
                </TitleContent>
                <ChildContent>
                    <MudTable Items="columns" Hover="true" Striped="true" Bordered="true">
                        <HeaderContent>
                            <MudTh>Название колонки</MudTh>
                            <MudTh>Тип данных</MudTh>
                            <MudTh>Первичный ключ</MudTh>
                            <MudTh>Обязательное поле</MudTh>
                            <MudTh>Действия</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Name</MudTd>
                            <MudTd>@context.Type</MudTd>
                            <MudTd>
                                @if (context.IsPrimaryKey)
                                {<MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" />}
                                else
                                {<MudIcon Icon="@Icons.Material.Filled.Close" Color="Color.Error" />}
                            </MudTd>
                            <MudTd>
                                @if (context.IsRequired)
                                {<MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" />}
                                else
                                {<MudIcon Icon="@Icons.Material.Filled.Close" Color="Color.Error" />}
                            </MudTd>
                            <MudTd>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="() => RemoveColumn(context)" Color="Color.Error" Size="Size.Small" />
                            </MudTd>
                        </RowTemplate>
                        <NoRecordsContent>
                            <MudText>Добавьте хотя бы одну колонку для создания таблицы</MudText>
                        </NoRecordsContent>
                    </MudTable>
                </ChildContent>
            </MudExpansionPanel>
        </MudTabPanel>
    </MudTabs>

    <!-- Общий блок для выбора файла и параметров импорта -->
    <MudCard Elevation="4" Class="mb-4 pa-4">
        <MudCardHeader>
            <MudText Typo="Typo.h6">Параметры импорта и выбор файла</MudText>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudFileUpload T="IBrowserFile" OnFilesChanged="OnInputFileChanged" Accept=".csv,.xml" MaxFiles="1" Class="mt-3">
                        <ActivatorContent>
                            <MudButton HtmlTag="label"
                                       Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.CloudUpload"
                            >
                                @if (selectedFile == null)
                                {
                                    <span>Выбрать файл (CSV или XML)</span>
                                }
                                else
                                {
                                    <span>@selectedFile.Name</span>
                                }
                            </MudButton>
                        </ActivatorContent>
                    </MudFileUpload>
                    @if (selectedFile != null)
                    {
                        <MudText Typo="Typo.caption" Class="mt-1">Размер файла: @(selectedFile.Size / 1024) Кб</MudText>
                    }
                </MudItem>

                @if (IsCSVFile())
                {
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="@csvDelimiter"
                                      Label="Разделитель CSV"
                                      HelperText="Разделитель для CSV (по умолчанию ',')"
                                      AdornmentIcon="@Icons.Material.Filled.FormatListBulleted"
                                      MaxLength="1" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudCheckBox T="bool" @bind-Checked="@hasHeaderRow"
                                     Label="Файл содержит строку заголовков"
                                     Color="Color.Primary" />
                    </MudItem>
                    @* <MudItem xs="12" sm="6"> *@
                    @*     <MudSelect T="string" Label="Кодировка" @bind-Value="fileEncoding"> *@
                    @*         <MudSelectItem Value="UTF-8">UTF-8</MudSelectItem> *@
                    @*         <MudSelectItem Value="Windows-1251">Windows-1251</MudSelectItem> *@
                    @*         <MudSelectItem Value="ISO-8859-1">ISO-8859-1</MudSelectItem> *@
                    @*     </MudSelect> *@
                    @* </MudItem> *@
                }

                @if (IsXMLFile())
                {
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="@xmlRootElement"
                                      Label="Корневой элемент XML"
                                      HelperText="Название корневого элемента (по умолчанию определяется автоматически)"
                                      AdornmentIcon="@Icons.Material.Filled.Code" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="@xmlRowElement"
                                      Label="Элемент строки XML"
                                      HelperText="Название элемента, представляющего строку данных"
                                      AdornmentIcon="@Icons.Material.Filled.ViewList" />
                    </MudItem>
                }
            </MudGrid>
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="@(async () => await StartImport())"
                       Disabled="@(!CanStartImport())"
                       StartIcon="@Icons.Material.Filled.Publish">
                Начать импорт
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       OnClick="ResetForm"
                       StartIcon="@Icons.Material.Filled.Refresh">
                Сбросить
            </MudButton>
        </MudCardActions>
    </MudCard>

    @if (isImporting)
    {
        <MudPaper Class="pa-4 my-4 mud-theme-primary">
            <MudProgressLinear Color="Color.Secondary" Indeterminate="true" Class="my-2" />
            <MudText Align="Align.Center">Выполняется импорт данных...</MudText>
        </MudPaper>
    }

    @if (importResult != null)
    {
        <MudCard Elevation="4" Class="mt-4 pa-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Результат импорта</MudText>
                </CardHeaderContent>
                <CardHeaderActions>
                    <MudChip T="string" Color="@(importResult.Success ? Color.Success : Color.Error)"
                             Icon="@(importResult.Success ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)">
                        @(importResult.Success ? "Успешно" : "Ошибка")
                    </MudChip>
                </CardHeaderActions>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12">
                        <MudText>@importResult.Message</MudText>
                    </MudItem>

                    @if (importResult.Success)
                    {
                        <MudItem xs="12" sm="6" md="4">
                            <MudPaper Class="pa-4 mud-theme-primary">
                                <MudText Typo="Typo.h6" Class="mb-2">Обработано строк</MudText>
                                <MudText Typo="Typo.h4">@importResult.RowsProcessed</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudPaper Class="pa-4 mud-theme-secondary">
                                <MudText Typo="Typo.h6" Class="mb-2">Ошибок</MudText>
                                <MudText Typo="Typo.h4">@importResult.RowsProcessed</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudPaper Class="pa-4 mud-theme-tertiary">
                                <MudText Typo="Typo.h6" Class="mb-2">Успешно импортировано</MudText>
                                <MudText Typo="Typo.h4">@(importResult.RowsProcessed - importResult.ErrorCount)</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12">
                            <MudText Typo="Typo.body2" Class="mt-2">
                                Время выполнения: @(importResult.ElapsedTimeMs / 1000.0) секунд
                            </MudText>
                        </MudItem>
                    }

                    @if (importResult.Errors != null && importResult.Errors.Count > 0)
                    {
                        <MudItem xs="12">
                            <MudExpansionPanel Class="mt-2">
                                <TitleContent>
                                    <MudText>Детали ошибок (@importResult.Errors.Count)</MudText>
                                </TitleContent>
                                <ChildContent>
                                    <MudTable Items="@importResult.Errors"
                                              Hover="true"
                                              Striped="true"
                                              Bordered="true"
                                              Elevation="0">
                                        <HeaderContent>
                                            <MudTh>Строка</MudTh>
                                            <MudTh>Ошибка</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd DataLabel="Строка">@context.RowNumber</MudTd>
                                            <MudTd DataLabel="Ошибка">@context.ErrorMessage</MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </ChildContent>
                            </MudExpansionPanel>
                        </MudItem>
                    }
                </MudGrid>
            </MudCardContent>
        </MudCard>
    }
</MudContainer>